<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Eventverwaltung</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 600px; }
    input, button, textarea, select { width: 100%; margin: 6px 0; padding: 8px; }
    fieldset { margin-top: 20px; }
  </style>
</head>
<body>

  <h2>🎉 Neue Events hinzufügen</h2>

  <form id="eventForm">
    <label>Monat:
      <input type="text" id="monat" required placeholder="z. B. August">
    </label>

    <label>Eventname (mit &lt;br/&gt; für Umbruch):
      <input type="text" id="eventname" required placeholder="z. B. Weinfest Dieblich">
    </label>

    <label>Termine (durch Komma trennen):
      <input type="text" id="termine" required placeholder="z. B. 22.8,24.8">
    </label>

    <button type="button" onclick="addEvent()">➕ Event hinzufügen</button>
  </form>

  <fieldset>
    <legend>✏️ Bestehende Termine aktualisieren</legend>

    <label>Monat auswählen:
      <select id="monatSelect" onchange="populateEventSelect()">
        <option value="">-- bitte wählen --</option>
      </select>
    </label>

    <label>Event auswählen:
      <select id="eventSelect">
        <option value="">-- bitte wählen --</option>
      </select>
    </label>

    <label>Neue Termine (ersetzt die alten):
      <input type="text" id="neueTermine" placeholder="z. B. 23.8,25.8">
    </label>
    <label>Neuer Eventname (optional – umbenennen):
  <input type="text" id="neuerEventname" placeholder="z. B. Weinfest in Dieblich">
</label>

<button type="button" onclick="renameEvent()">✏️ Eventnamen ändern</button>

    <button type="button" onclick="updateEvent()">🔁 Event-Termine aktualisieren</button>
  </fieldset>

  <button onclick="downloadJSON()">📥 JSON speichern</button>

  <h3>📦 Vorschau:</h3>
  <pre id="jsonPreview" style="background:#f0f0f0; padding:10px;"></pre>

  <script>
    const eventData = {};

    function addEvent() {
      const monat = document.getElementById('monat').value.trim();
      const eventname = document.getElementById('eventname').value.trim();
      const termine = document.getElementById('termine').value.split(',').map(t => t.trim()).filter(Boolean);

      if (!monat || !eventname || termine.length === 0) {
        alert("Bitte alle Felder ausfüllen.");
        return;
      }

      if (!eventData[monat]) {
        eventData[monat] = {
          month: monat,
          events: [],
        };
        updateMonatSelect(); // neue Monate zum Select hinzufügen
      }

      if (!eventData[monat].events.includes(eventname)) {
        eventData[monat].events.push(eventname);
        eventData[monat][eventname] = termine;
      } else {
        // existierendes Event → weitere Termine ergänzen
        eventData[monat][eventname].push(...termine);
        eventData[monat][eventname] = [...new Set(eventData[monat][eventname])]; // Duplikate entfernen
      }

      document.getElementById('eventForm').reset();
      updatePreview();
    }

    function updateMonatSelect() {
      const monatSelect = document.getElementById('monatSelect');
      monatSelect.innerHTML = `<option value="">-- bitte wählen --</option>`;
      Object.keys(eventData).forEach(monat => {
        const opt = document.createElement('option');
        opt.value = monat;
        opt.textContent = monat;
        monatSelect.appendChild(opt);
      });
    }

    function populateEventSelect() {
      const monat = document.getElementById('monatSelect').value;
      const eventSelect = document.getElementById('eventSelect');
      eventSelect.innerHTML = `<option value="">-- bitte wählen --</option>`;

      if (monat && eventData[monat]) {
        eventData[monat].events.forEach(evt => {
          const opt = document.createElement('option');
          opt.value = evt;
          opt.textContent = evt;
          eventSelect.appendChild(opt);
        });
      }
    }

    function updateEvent() {
      const monat = document.getElementById('monatSelect').value;
      const eventname = document.getElementById('eventSelect').value;
      const neueTermine = document.getElementById('neueTermine').value.split(',').map(t => t.trim()).filter(Boolean);

      if (!monat || !eventname || neueTermine.length === 0) {
        alert("Bitte Monat, Event und neue Termine eingeben.");
        return;
      }

      if (eventData[monat] && eventData[monat].events.includes(eventname)) {
        eventData[monat][eventname] = neueTermine;
        alert("Termine wurden aktualisiert.");
        document.getElementById('neueTermine').value = '';
        updatePreview();
      } else {
        alert("Event nicht gefunden.");
      }
    }
    function renameEvent() {
  const monat = document.getElementById('monatSelect').value;
  const alterName = document.getElementById('eventSelect').value;
  const neuerName = document.getElementById('neuerEventname').value.trim();

  if (!monat || !alterName || !neuerName) {
    alert("Bitte Monat, bestehenden Event und neuen Namen angeben.");
    return;
  }

  if (!eventData[monat] || !eventData[monat][alterName]) {
    alert("Event nicht gefunden.");
    return;
  }

  if (eventData[monat][neuerName]) {
    alert("Ein Event mit diesem Namen existiert bereits.");
    return;
  }

  // Daten übernehmen & alten löschen
  eventData[monat][neuerName] = eventData[monat][alterName];
  delete eventData[monat][alterName];

  // In der events-Liste ersetzen
  const index = eventData[monat].events.indexOf(alterName);
  if (index !== -1) {
    eventData[monat].events[index] = neuerName;
  }

  alert("Eventname wurde geändert.");
  document.getElementById('neuerEventname').value = '';
  populateEventSelect();
  updatePreview();
}


    function updatePreview() {
      const arr = Object.values(eventData);
      document.getElementById('jsonPreview').textContent = JSON.stringify(arr, null, 2);
    }

    function downloadJSON() {
    
      const dataToSend = Object.values(eventData);
      console.log("EventData"+eventData[0]);
     //  const dataToSend = arr[0]; 
      const blob = new Blob([JSON.stringify(dataToSend, null, 2)], { type: "application/json" });
      const url =   '/download-events'; // Zugriff über öffentlich erreichbaren Pfad;
     

            fetch('/save-event', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify( dataToSend )
            })
            .then(res => res.json())
            .then(data => {
            if (data.exists) {
                alert("Datei existiert bereits.");
            } else {
                alert("Datei existiert nicht – kann gespeichert werden.");
               
            }
            });


      

     
    }
  </script>

</body>
</html>
