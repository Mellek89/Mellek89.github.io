<!DOCTYPE html>
<html lang = "en"  dir = "ltr">
    
<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  
  <!-- Cache deaktivieren -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- Content Security Policy -->
<meta http-equiv="Content-Security-Policy" 
      content="default-src 'self'; 
               connect-src 'self'; 
               style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net https://www.w3schools.com; 
               font-src 'self' https://fonts.googleapis.com https://fonts.gstatic.com https://cdn.jsdelivr.net; 
               script-src 'self' https://cdn.jsdelivr.net https://cdn.jsdelivr.net/npm 'unsafe-inline'; 
               img-src 'self' data:;">
  <title>Admin</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="./imagesOptimized/images/Lango-laenge-Logo.png">

  <!-- Externe Styles -->
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@7.2.3/css/flag-icons.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
  <link rel="stylesheet" href="style.css">

  <!-- Flatpickr CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <!-- Viewport -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Externe Scripts -->
  <script src="jquery-3.7.1.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/de.js"></script>

  <!-- Inline Styles für schnelle Layout-Anpassungen -->
  <style>
    input, button, textarea, select { width: 100%; margin: 6px 0; padding: 8px; }
    fieldset { margin-top: 20px; }
  </style>
</head>


  <body>

    
  <div class="container"> 
      <header class="header">
          <!--Hamburger Icon-->
      <input class="side-menu" title="hamb" type="checkbox" id="side-menu"/>
      <label class="hamb" id="hamb" for="side-menu"><span class="hamb-line"></span></label>
      <div class="logoDiv" > <picture>
  <source srcset="./imagesOptimized/images/avif/Lango-laenge-Logo.avif" type="image/avif">
  <source srcset="./imagesOptimized/images/webp/Lango-laenge-Logo.webp" type="image/webp">
  <img src="./imagesOptimized/images/Lango-laenge-Logo.png" class="logoMobil">
</picture></div>

     
      <!--Menu-->
      <nav class="nav" id="nav">
        <ul class="menu">
         <li class="home"> <a  href="index.html">Home</a></li>
          <li class="events"><a  href="events.html">Events</a></li>
          <li class="langos"><a  href="langos.html">Langos</a></li>
          <li class="logo"> <picture>
  <source srcset="./imagesOptimized/images/avif/Lango-laenge-Logo.avif" type="image/avif">
  <source srcset="./imagesOptimized/images/webp/Lango-laenge-Logo.webp" type="image/webp">
  <img src="./imagesOptimized/images/Lango-laenge-Logo.png" class="logoImg" alt="Lango Laenge company logo">
</picture></li>
          <li class="uns"><a href="uns.html">Über uns</a></li>
          <li class="news" ><a  href="news.html">News</a></li>
          <li class="kontakt"><a href="kontakt.html">Kontakt</a></li>
        </ul>
      </nav>


    </header>



  <main class="main" id="main">
   
    
        <h1 class="hAdmin">Termine eintragen für</h1>
        <div class="regionsAdmin">
           <label class="Mittelrhein"  style="display: flex; align-items: center; gap: 5px;">
            <input type="radio" name="region" value="Mittelrhein" id="MittelrheinAdmin" autocomplete="off">
                <span>Mittelrhein</span>
          </label>
          <label class="Oberrhein" style="display: flex; align-items: center; gap: 5px;">
                  <input type="radio" name="region" value="Oberrhein" class="Oberrhein" id="OberrheinAdmin" autocomplete="off">
                <span>Oberrhein</span>
          </label>
        </div>

         <button type="button" class="create-btn" id="create" title="Neuen termin anlegen" aria-label="Erstellen"
                      style="background:#37a2ed; border:none; color:white; padding:4px 6px; border-radius:4px; cursor:pointer;">+</button>
<div class="formContainer">
     <div class="inputEvents" style="width: 60%;" >
      <div class="dropdown-menu" id="dropdown-menu">
          <span class="dropdown-item"></span>
      </div>

    </div>
<div class="error" id="error-box" style="display:none; color:red;"></div>
      <div class="calendar" id="calendar">
        
        <header>
          <p class="current-date"></p>
        
          <div class="icons">
            <span id = "prev" class="material-symbols-rounded">chevron_left</span>
            <span id = "next" class="material-symbols-rounded">chevron_right</span>
          </div>
          </header>
        <ul class="weeks">
          <li>So</li>
          <li>Mo</li>
          <li>Di</li>
          <li>Mi</li>
          <li>Do</li>
         <li>Fr</li>
          <li>Sa</li> 
        </ul>
        <ul class="days">

          
        </ul> 

      </div>
        <form id="zeitraumForm" class="zeitraumForm">
    <div class="eventName" id="eventName">
         <label  class="eventname" for="eventname"><strong>Eventname :</strong></label> 
              <input type="text" id="eventname" required placeholder="z. B. Weihnachtsmarkt Durlach">
                                  
              <div style="display: flex; gap: 20px; align-items: center;">
        </div>
      </div>

        <div class="period" id="period" style="margin-top: 10px;">
          <span class="eventTemp" id="eventTemp"><strong>Zeitraum:</strong></span><br><br>
        </div>
        <div id="Weekmarket">
          <label for="checkbox1" class="weekmarket" >
            <strong>Wochenmarkt</strong>
            <input type="checkbox" id="weekmarket" name="option1" value="value1" style="width: 20%;">
            </label> 
          </div>
            
          <button class="preview" id="prevView" type="submit">Vorschau anzeigen</button>
      </form>
  <dialog id="confirmModal"  class="modal">
  <h3>Ist folgendes korrekt?</h3>
  <ul>
    <li><strong>Region:</strong> <span id="regionField"></span></li>
    <li><strong>Event:</strong> <span id="eventField"></span></li>
    <li><strong>Zeitraum:</strong> <span id="zeitraumField"></span></li>
     <li > <span id="showWeekmarket"></span></li>
  </ul>
  <div style="margin-top:1em; display:flex; gap:1em; justify-content:flex-end;">
    <button id="saveBtn" class="saveBtn">Ja, bitte speichern</button>
    <button id="udBtn" class="udBtn"> Nein, bitte korrigieren</button>
  </div>
</dialog>


  <dialog id="confirmDeleteModal"  class="delmodal">
  <h3>Soll das Event wirklich gelöscht werden? ?</h3>
  <ul>
    <li><strong>Region:</strong> <span id="regionFieldForDel"></span></li>
    <li><strong>Event:</strong> <span id="eventFieldForDel"></span></li>
    <li><strong>Zeitraum:</strong> <span id="zeitraumFieldForDel"></span></li>
    <li id="weekmarketForDel"><strong>Wochenmarkt</strong> <span ></span></li>
    
  </ul>
  <div style="margin-top:1em; display:flex; gap:1em; justify-content:flex-end;">
    <button id="delBtn" class="delBtn">Ja, bitte löschen</button>
    <button id="cancel" class="cancel"> Nein, bitte abbrechen</button>
  </div>
</dialog>

    </div>


    

            <div id="ausgabe" style="margin-top: 20px;"></div>
  <div id="bestaetigung" style="margin-top: 20px;"></div>
  <pre id="jsonPreview" style="padding: 10px;"></pre>
  
</main>

        <footer class="footer" id="footer">
          <div class="formContainer">
  <h2>Angemeldete Benutzer</h2>
  <table id="userTable"; style="width:100%; border-collapse:collapse; border:1" >
    <thead>
      <tr>
        <th>Benutzername</th>
        <th>Rolle</th>
        <th>Status</th>
        <th>Logout</th>
      </tr>
    </thead>
    <tbody>
      <!-- User werden hier eingefügt -->
    </tbody>
  </table>
</div>

       
      
      
        
  




        </footer>
    </div>
<script src="/socket.io/socket.io.js"></script>
<script>
    
document.getElementById("create").addEventListener("click", function() {
  if (window.innerWidth < 768) {
    document.getElementById("calendar").scrollIntoView({
      behavior: "smooth"
    });
  }
  });

  async function verifyToken() {
  const token = localStorage.getItem("jwt");
   
  if (!token) {
    // Kein Token → zurück zum Login
    window.location.href = "/login.html";
    return null;
  }

  try {
    const res = await fetch("/verify", {
      method: "POST",
      headers: { "Authorization": "Bearer " + token }
    });

    if (!res.ok) {
      // Token abgelaufen oder ungültig
      localStorage.removeItem("jwt");
      window.location.href = "/login.html";
      return null;
    }

    const data = await res.json();
    console.log("✅ Token gültig für Benutzer:", data.username);
    return data;
  } catch (err) {
    console.error("Verbindungsfehler bei Tokenprüfung:", err);
    window.location.href = "/login.html";
  }
}

async function startApp() {
  const user = await verifyToken();
  if (!user) return; // Abbruch, falls ungültig

  const socket = io();
 const token = localStorage.getItem("jwt");
  socket.emit("registerUser", token);
 
  // ⚠️ forceLogout: wenn der Server die Sitzung beendet
socket.on("forceLogout", () => {
  console.warn(" Sitzung abgelaufen. Du wirst ausgeloggt...");
  localStorage.removeItem("jwt");
  alert("Deine Sitzung ist abgelaufen. Bitte melde dich erneut an.");
  window.location.href = "/login.html";
});
 socket.on("connect", () => {
    console.log("🔌 Verbunden als:", user.username);
  });


  socket.on("updateUsers", (users) => {
    const tbody = document.querySelector("#userTable tbody");
    tbody.innerHTML = "";
    users.forEach(u => {
      tbody.insertAdjacentHTML("beforeend", `
        <tr>
          <td>${u.username}</td>
          <td>${u.role}</td>
          <td>✅</td>
          <td>${
            u.username === user.username
              ? `<button class="logoutIconBtn" title="Abmelden">
                   <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                     <path d="M19 22H5a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v18a1 1 0 0 1-1 1zM6 20h12V4H6v16zm8-7a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/>
                   </svg>
                 </button>`
              : "–"
          }</td>
        </tr>
      `);
    });

    // Logout-Event für den eigenen Button
    const logoutBtn = document.querySelector(".logoutIconBtn");
    if (logoutBtn) {
      logoutBtn.addEventListener("click", async () => {
        const token = localStorage.getItem("jwt");
        const res = await fetch("/logout", {
          method: "POST",
          headers: { "Authorization": "Bearer " + token }
        });
        localStorage.removeItem("jwt");
        window.location.href = "/login.html";
      });
    }
  });
}

// Startet alles, nachdem verifyToken erfolgreich war
startApp();
</script>



    <script type= "module" src="/events.js?v=2025-09-28" ></script>

  </body>
</html>